<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .btn {
            transition: transform 0.1s ease-in-out, background-color 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-2xl bg-white rounded-2xl card p-8 sm:p-10">

        <!-- Initial Auth Screen -->
        <div id="auth-screen" class="text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 sm:text-4xl">Welcome!</h1>
            <p class="text-gray-600 mb-8 text-sm sm:text-base">Please sign in to track your expenses.</p>
            <button id="sign-in-google-btn"
                class="btn w-full max-w-xs bg-indigo-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6 mr-3">
                    <path
                        d="M23.954 12.222c0-.608-.055-1.217-.184-1.802H12v3.784h6.504a4.34 4.34 0 01-1.815 2.868v2.336h2.956A9.284 9.284 0 0023.954 12.222z"
                        fill="#4285F4" />
                    <path
                        d="M12 23.998c3.235 0 5.92-1.07 7.892-2.894l-2.956-2.336c-1.396.93-3.197 1.488-4.936 1.488-3.778 0-6.99-2.55-8.15-5.962H.657v2.404A11.996 11.996 0 0012 23.998z"
                        fill="#34A853" />
                    <path
                        d="M3.85 14.64a7.002 7.002 0 010-4.636V7.599H.657a11.997 11.997 0 000 8.794L3.85 14.64z"
                        fill="#FBBC05" />
                    <path
                        d="M12 5.998c1.65 0 3.14.6 4.316 1.517l2.583-2.583C17.915 2.508 15.19 1.5 12 1.5c-3.235 0-5.92 1.07-8.15 3.013l3.204 2.404c1.16-3.412 4.372-5.968 8.146-5.968z"
                        fill="#EA4335" />
                </svg>
                <span>Sign in with Google</span>
            </button>
            <p id="user-info" class="text-xs text-gray-400 mt-4"></p>
        </div>


        <!-- Initial Landing Page -->
        <div id="landing-page" class="hidden text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 sm:text-4xl">Welcome!</h1>
            <p class="text-gray-600 mb-8 text-sm sm:text-base">Let's start tracking your household expenses.</p>
            <div class="flex flex-col space-y-4">
                <button id="create-house-btn"
                    class="btn bg-indigo-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Create a House
                </button>
                <button id="join-house-btn"
                    class="btn bg-green-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Join a House
                </button>
            </div>
            <p id="user-info" class="text-xs text-gray-400 mt-4"></p>
        </div>

        <!-- Create House Form -->
        <div id="create-house-form" class="hidden text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 sm:text-3xl">Create a New House</h2>
            <form id="create-form" class="space-y-4 text-left">
                <div>
                    <label for="house-name" class="block text-gray-700 font-medium mb-1">House Name</label>
                    <input type="text" id="house-name" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="join-code" class="block text-gray-700 font-medium mb-1">Create a 4-digit Join Code</label>
                    <input type="password" id="join-code" required minlength="4" maxlength="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit"
                    class="btn w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 mt-6">
                    Create House
                </button>
                <button type="button" id="back-to-landing-create" class="w-full mt-2 text-sm text-gray-500 hover:underline">
                    Back
                </button>
            </form>
        </div>

        <!-- Join House Form -->
        <div id="join-house-form" class="hidden text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 sm:text-3xl">Join a House</h2>
            <form id="join-form" class="space-y-4 text-left">
                <div>
                    <label for="join-house-name" class="block text-gray-700 font-medium mb-1">House Name</label>
                    <input type="text" id="join-house-name" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label for="join-code-input" class="block text-gray-700 font-medium mb-1">4-digit Join Code</label>
                    <input type="password" id="join-code-input" required minlength="4" maxlength="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <button type="submit"
                    class="btn w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mt-6">
                    Join House
                </button>
                <button type="button" id="back-to-landing-join" class="w-full mt-2 text-sm text-gray-500 hover:underline">
                    Back
                </button>
            </form>
        </div>

        <!-- Main Expense Tracker View -->
        <div id="expense-tracker" class="hidden fade-in">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 sm:mb-8">
                <div>
                    <h2 id="house-name-display" class="text-3xl font-bold text-gray-800"></h2>
                    <p id="house-id-display" class="text-gray-600 text-xs mt-1"></p>
                </div>
                <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                    <button id="leave-house-btn" class="btn p-2 rounded-lg bg-red-500 text-white text-sm hover:bg-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                        </svg>
                    </button>
                    <button id="sign-out-btn" class="btn p-2 rounded-lg bg-gray-500 text-white text-sm hover:bg-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Total Expenses Display -->
            <div class="bg-gray-200 text-gray-800 p-6 rounded-2xl mb-8 text-center font-bold card">
                <span class="text-xl sm:text-2xl">Total Expenses:</span>
                <span id="total-expenses" class="text-4xl font-extrabold ml-2 text-indigo-600 sm:text-5xl">$0.00</span>
            </div>

            <!-- Add Expense Form -->
            <form id="add-expense-form" class="space-y-4 mb-8">
                <div>
                    <label for="expense-description" class="block text-gray-700 font-medium mb-1">Description</label>
                    <input type="text" id="expense-description" placeholder="e.g., Groceries" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="expense-amount" class="block text-gray-700 font-medium mb-1">Amount ($)</label>
                    <input type="number" id="expense-amount" placeholder="e.g., 50.75" step="0.01" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit"
                    class="btn w-full bg-indigo-500 text-white py-3 rounded-lg font-semibold flex items-center justify-center space-x-2 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    <span>Add Expense</span>
                </button>
            </form>

            <!-- Expense List -->
            <ul id="expense-list" class="space-y-4"></ul>

            <!-- Generic Modal Dialog -->
            <div id="modal-dialog" class="dialog-backdrop hidden">
                <div class="bg-white rounded-2xl p-8 max-w-sm w-full card text-center">
                    <p id="modal-message" class="text-gray-800 text-lg mb-6"></p>
                    <button id="modal-ok-btn"
                        class="btn w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        OK
                    </button>
                </div>
            </div>

            <!-- Edit Expense Modal Dialog -->
            <div id="edit-modal-dialog" class="dialog-backdrop hidden">
                <div class="bg-white rounded-2xl p-8 max-w-sm w-full card">
                    <h3 class="text-xl font-bold mb-4">Edit Expense</h3>
                    <form id="edit-form" class="space-y-4">
                        <input type="hidden" id="edit-expense-id">
                        <div>
                            <label for="edit-expense-description" class="block text-gray-700 font-medium mb-1">Description</label>
                            <input type="text" id="edit-expense-description" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="edit-expense-amount" class="block text-gray-700 font-medium mb-1">Amount ($)</label>
                            <input type="number" id="edit-expense-amount" step="0.01" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="edit-cancel-btn"
                                class="btn px-6 py-3 rounded-lg text-gray-600 hover:bg-gray-200">
                                Cancel
                            </button>
                            <button type="submit"
                                class="btn px-6 py-3 rounded-lg bg-indigo-500 text-white font-semibold hover:bg-indigo-600">
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithRedirect, onAuthStateChanged, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and app state
        let app, db, auth;
        let userId = null;
        let houseId = null;
        let houseData = null;
        let unsubscribeExpenses = null;

        // Constants for Firestore paths
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // UI Elements
        const authScreen = document.getElementById('auth-screen');
        const signInGoogleBtn = document.getElementById('sign-in-google-btn');
        const landingPage = document.getElementById('landing-page');
        const createHouseBtn = document.getElementById('create-house-btn');
        const joinHouseBtn = document.getElementById('join-house-btn');
        const createHouseFormDiv = document.getElementById('create-house-form');
        const joinHouseFormDiv = document.getElementById('join-house-form');
        const createForm = document.getElementById('create-form');
        const joinForm = document.getElementById('join-form');
        const expenseTrackerDiv = document.getElementById('expense-tracker');
        const houseNameDisplay = document.getElementById('house-name-display');
        const houseIdDisplay = document.getElementById('house-id-display');
        const userDisplay = document.getElementById('user-info');
        const totalExpensesDisplay = document.getElementById('total-expenses');
        const expenseList = document.getElementById('expense-list');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const leaveHouseBtn = document.getElementById('leave-house-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const modalDialog = document.getElementById('modal-dialog');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const editModalDialog = document.getElementById('edit-modal-dialog');
        const editForm = document.getElementById('edit-form');
        const editExpenseIdInput = document.getElementById('edit-expense-id');
        const editExpenseDescriptionInput = document.getElementById('edit-expense-description');
        const editExpenseAmountInput = document.getElementById('edit-expense-amount');
        const editCancelBtn = document.getElementById('edit-cancel-btn');


        document.addEventListener('DOMContentLoaded', () => {

            // Initialize Firebase
            const initFirebase = async () => {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. App cannot function.");
                    return;
                }

                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDisplay.textContent = `User ID: ${userId}`;
                        await loadUserHouse();
                    } else {
                        showView('auth-screen');
                    }
                });
            };

            const authenticateUser = async () => {
                try {
                    console.log("Attempting to sign in with Google...");
                    const provider = new GoogleAuthProvider();
                    await signInWithRedirect(auth, provider);
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showModal("Authentication failed. Please try again.");
                }
            };

            const loadUserHouse = async () => {
                const houseRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'house');
                const houseSnap = await getDoc(houseRef);
                if (houseSnap.exists() && houseSnap.data().houseId) {
                    const data = houseSnap.data();
                    houseId = data.houseId;
                    await getHouseDetails(houseId);
                    showView('expense-tracker');
                } else {
                    showView('landing-page');
                }
            };

            const getHouseDetails = async (id) => {
                const houseDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'houses', id);
                const houseSnap = await getDoc(houseDocRef);
                if (houseSnap.exists()) {
                    houseData = houseSnap.data();
                    houseNameDisplay.textContent = houseData.houseName;
                    houseIdDisplay.textContent = `House ID: ${id}`;
                    startExpenseListener(id);
                } else {
                    showModal("House not found. You may have been removed or the house was deleted.");
                    await clearUserHouseSetting();
                    showView('landing-page');
                }
            };

            const clearUserHouseSetting = async () => {
                const houseRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'house');
                await setDoc(houseRef, { houseId: null });
            };

            const showView = (viewId) => {
                console.log(`Switching to view: ${viewId}`);
                const views = [authScreen, landingPage, createHouseFormDiv, joinHouseFormDiv, expenseTrackerDiv];
                views.forEach(view => {
                    view.classList.add('hidden');
                    view.classList.remove('flex');
                    view.classList.remove('flex-col');
                });

                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    targetView.classList.add('flex', 'flex-col');
                }
            };

            const showModal = (message) => {
                modalMessage.textContent = message;
                modalDialog.classList.remove('hidden');
            };

            modalOkBtn.addEventListener('click', () => {
                modalDialog.classList.add('hidden');
            });

            // Event Listeners for UI transitions
            signInGoogleBtn.addEventListener('click', authenticateUser);
            createHouseBtn.addEventListener('click', () => showView('create-house-form'));
            joinHouseBtn.addEventListener('click', () => showView('join-house-form'));
            document.getElementById('back-to-landing-create').addEventListener('click', () => showView('landing-page'));
            document.getElementById('back-to-landing-join').addEventListener('click', () => showView('landing-page'));
            signOutBtn.addEventListener('click', async () => {
                if (unsubscribeExpenses) {
                    unsubscribeExpenses();
                }
                houseId = null;
                await clearUserHouseSetting();
                await signOut(auth);
            });

            // Create House Logic
            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const houseName = document.getElementById('house-name').value.trim();
                const joinCode = document.getElementById('join-code').value.trim();

                if (!houseName || joinCode.length !== 4) {
                    showModal("Please fill out all fields correctly. The join code must be 4 digits.");
                    return;
                }

                try {
                    const housesRef = collection(db, 'artifacts', appId, 'public', 'data', 'houses');
                    const q = query(housesRef, where('houseName', '==', houseName));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showModal("A house with this name already exists. Please choose a different name.");
                        return;
                    }

                    const newHouseRef = await addDoc(housesRef, {
                        houseName: houseName,
                        joinCode: joinCode,
                        members: [userId],
                        createdAt: new Date()
                    });

                    houseId = newHouseRef.id;
                    await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'house'), { houseId: houseId });

                    houseNameDisplay.textContent = houseName;
                    houseIdDisplay.textContent = `House ID: ${houseId}`;
                    startExpenseListener(houseId);
                    showView('expense-tracker');

                } catch (error) {
                    console.error("Error creating house:", error);
                    showModal("Failed to create house. Please try again.");
                }
            });

            // Join House Logic
            joinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const joinHouseName = document.getElementById('join-house-name').value.trim();
                const joinCode = document.getElementById('join-code-input').value.trim();

                if (!joinHouseName || joinCode.length !== 4) {
                    showModal("Please enter both the house name and the 4-digit code.");
                    return;
                }

                try {
                    const housesRef = collection(db, 'artifacts', appId, 'public', 'data', 'houses');
                    const q = query(housesRef, where('houseName', '==', joinHouseName), where('joinCode', '==', joinCode));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        showModal("Invalid house name or join code. Please try again.");
                        return;
                    }

                    const houseDoc = querySnapshot.docs[0];
                    const houseDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'houses', houseDoc.id);
                    const houseData = houseDoc.data();

                    if (!houseData.members.includes(userId)) {
                        await updateDoc(houseDocRef, {
                            members: [...houseData.members, userId]
                        });
                    }

                    houseId = houseDoc.id;
                    await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'house'), { houseId: houseId });
                    
                    houseNameDisplay.textContent = houseData.houseName;
                    houseIdDisplay.textContent = `House ID: ${houseId}`;
                    startExpenseListener(houseId);
                    showView('expense-tracker');

                } catch (error) {
                    console.error("Error joining house:", error);
                    showModal("Failed to join house. Please try again.");
                }
            });

            // Leave House Logic
            leaveHouseBtn.addEventListener('click', async () => {
                if (unsubscribeExpenses) {
                    unsubscribeExpenses();
                }
                houseId = null;
                await clearUserHouseSetting();
                showView('landing-page');
            });

            // Expense Management
            const startExpenseListener = (currentHouseId) => {
                if (unsubscribeExpenses) {
                    unsubscribeExpenses();
                }

                const expensesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'houses', currentHouseId, 'expenses');
                unsubscribeExpenses = onSnapshot(expensesCollectionRef, (snapshot) => {
                    expenseList.innerHTML = '';
                    let total = 0;
                    if (snapshot.empty) {
                        expenseList.innerHTML = `<p class="text-gray-500 text-center">No expenses added yet.</p>`;
                    } else {
                        snapshot.docs.forEach(doc => {
                            const expense = { id: doc.id, ...doc.data() };
                            renderExpense(expense);
                            total += expense.amount;
                        });
                    }
                    totalExpensesDisplay.textContent = `$${total.toFixed(2)}`;
                }, (error) => {
                    console.error("Error listening to expenses:", error);
                    showModal("Failed to load expenses. Please reload the page.");
                });
            };

            const renderExpense = (expense) => {
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-4 rounded-xl bg-white card`;
                li.innerHTML = `
                    <div class="flex-1 flex flex-col min-w-0">
                        <span class="font-medium text-gray-800 text-lg">${expense.description}</span>
                        <span class="text-gray-600 text-sm mt-1">$${expense.amount.toFixed(2)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-id="${expense.id}"
                            class="edit-btn p-2 text-indigo-500 hover:text-indigo-700 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.204-8.204zm-3.86 3.86a2.25 2.25 0 113.182 3.182L13.182 8.182z" />
                            </svg>
                        </button>
                        <button data-id="${expense.id}"
                            class="delete-btn p-2 text-red-500 hover:text-red-700 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.31-.776-.324-1.579-1.15-.411L15.422 17.618a1.2 1.2 0 01-.89 1.137l-2.006.183c-.928.085-1.745-.487-1.92-1.354L8.765 4.102a.75.75 0 011.082-.676l5.77 2.885z" />
                            </svg>
                        </button>
                    </div>
                `;
                expenseList.appendChild(li);

                // Add event listeners for the new elements
                li.querySelector('.edit-btn').addEventListener('click', (e) => showEditModal(e.currentTarget.dataset.id));
                li.querySelector('.delete-btn').addEventListener('click', (e) => showDeleteConfirmation(e.currentTarget.dataset.id));
            };

            const addExpenseForm = document.getElementById('add-expense-form');
            addExpenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const description = expenseDescriptionInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);

                if (description !== '' && !isNaN(amount) && houseId) {
                    try {
                        const expensesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'houses', houseId, 'expenses');
                        await addDoc(expensesCollectionRef, {
                            description: description,
                            amount: amount,
                            createdAt: new Date()
                        });
                        addExpenseForm.reset();
                    } catch (error) {
                        console.error("Error adding document:", error);
                        showModal("Failed to add expense. Please try again.");
                    }
                }
            });

            // Edit Modal Logic
            const showEditModal = async (expenseId) => {
                const expenseRef = doc(db, 'artifacts', appId, 'public', 'data', 'houses', houseId, 'expenses', expenseId);
                const expenseSnap = await getDoc(expenseRef);
                if (!expenseSnap.exists()) {
                    showModal("Expense not found.");
                    return;
                }

                const currentExpense = expenseSnap.data();
                editExpenseIdInput.value = expenseId;
                editExpenseDescriptionInput.value = currentExpense.description;
                editExpenseAmountInput.value = currentExpense.amount;
                editModalDialog.classList.remove('hidden');
            };

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const expenseId = editExpenseIdInput.value;
                const newDescription = editExpenseDescriptionInput.value.trim();
                const newAmount = parseFloat(editExpenseAmountInput.value);

                if (newDescription !== '' && !isNaN(newAmount)) {
                    try {
                        const expenseRef = doc(db, 'artifacts', appId, 'public', 'data', 'houses', houseId, 'expenses', expenseId);
                        await updateDoc(expenseRef, {
                            description: newDescription,
                            amount: newAmount
                        });
                        editModalDialog.classList.add('hidden');
                    } catch (error) {
                        console.error("Error updating expense:", error);
                        showModal("Failed to update expense.");
                    }
                } else {
                    showModal("Invalid input for update. Please enter a valid description and amount.");
                }
            });

            editCancelBtn.addEventListener('click', () => {
                editModalDialog.classList.add('hidden');
            });

            // Delete Confirmation Modal Logic
            const showDeleteConfirmation = (expenseId) => {
                showModal("Are you sure you want to delete this expense?");
                // Temporarily change the OK button's function to handle the delete
                modalOkBtn.removeEventListener('click', modalOkBtn.currentHandler);
                modalOkBtn.currentHandler = async () => {
                    await deleteExpense(expenseId);
                    modalDialog.classList.add('hidden');
                    // Restore the original handler
                    modalOkBtn.removeEventListener('click', modalOkBtn.currentHandler);
                    modalOkBtn.addEventListener('click', () => modalDialog.classList.add('hidden'));
                };
                modalOkBtn.addEventListener('click', modalOkBtn.currentHandler);
            };

            const deleteExpense = async (expenseId) => {
                if (houseId) {
                    try {
                        const expenseDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'houses', houseId, 'expenses', expenseId);
                        await deleteDoc(expenseDocRef);
                    } catch (error) {
                        console.error("Error deleting expense:", error);
                        showModal("Failed to delete expense.");
                    }
                }
            };
            
            // Initialize the app
            initFirebase();
        });
    </script>
</body>

</html>
